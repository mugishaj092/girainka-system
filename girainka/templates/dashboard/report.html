{% extends 'dashboard/layout.html' %}

{% block title %}Report Dashboard{% endblock %}

{% block content %}
<div class="user-container">
  <div class="header">
    <input type="text" placeholder="Search name" class="search-bar">
    <div class="date-range">
      <label for="from">from</label>
      <input type="date" id="from" value="2023-04-04">
      <label for="to">to</label>
      <input type="date" id="to" value="2023-04-04">
    </div>
  </div>
  
  <!-- Table displaying report data -->
  <table>
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Message</th>
        <th>Address</th>
        <th>Phone</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for report in page_obj %}
      <tr id="report-{{ report.id }}">
        <td>{{ report.full_name }}</td>
        <td>{{ report.email }}</td>
        <td>{{ report.message }}</td>
        <td>{{ report.address }}</td>
        <td>{{ report.phone }}</td>
        <td>
          <button class="action-btn view-report-btn" data-id="{{ report.id }}">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn delete-report-btn" id="delete-report-{{ report.id }}" data-id="{{ report.id }}"><i class="fas fa-trash"></i></button>        
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6">No reports found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal for displaying report details -->
<div id="reportModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Report Details</h2>
    <div id="reportDetails">
      <!-- Report details will be populated here -->
    </div>
  </div>
</div>

<!-- Pagination controls -->
<div class="pagination-controls">
  <span>Rows Per Page:
    <select id="rowsPerPage" onchange="changeRowsPerPage(this.value)">
        <option value="5" {% if page_obj.paginator.per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if page_obj.paginator.per_page == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if page_obj.paginator.per_page == 15 %}selected{% endif %}>15</option>
        <option value="20" {% if page_obj.paginator.per_page == 20 %}selected{% endif %}>20</option>
    </select>
  </span>
  <span>{{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}</span>
  <span>
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&rows={{ page_obj.paginator.per_page }}" class="pagination-btn">Previous</a>
    {% else %}
    <span class="pagination-btn disabled">Previous</span>
    {% endif %}
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&rows={{ page_obj.paginator.per_page }}" class="pagination-btn">Next</a>
    {% else %}
    <span class="pagination-btn disabled">Next</span>
    {% endif %}
  </span>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const reportModal = document.getElementById("reportModal");
  const closeModalBtn = document.querySelector(".close-btn");
  const reportDetailsDiv = document.getElementById("reportDetails");

  // Open modal to view report details
  document.querySelectorAll(".action-btn.view-report-btn").forEach((button) => {
    button.addEventListener("click", function() {
      const reportId = this.getAttribute("data-id");
      console.log(reportId);
      fetch(`/get-report/${reportId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const report = data.report;
            // Populating modal with report details
            reportDetailsDiv.innerHTML = `
              <p><strong>Full Name:</strong> ${report.full_name}</p>
              <p><strong>Email:</strong> ${report.email}</p>
              <p><strong>Message:</strong> ${report.message}</p>
              <p><strong>Address:</strong> ${report.address}</p>
              <p><strong>Phone:</strong> ${report.phone}</p>
              <p><strong>Created At:</strong> ${report.created_at}</p>
            `;
            reportModal.style.display = "block";  // Show modal
          } else {
            alert("Failed to load report details.");
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("An error occurred while loading report data.");
        });
    });
  });

  // Close the modal
  closeModalBtn.addEventListener("click", () => {
    reportModal.style.display = "none";
  });

  window.addEventListener("click", (event) => {
    if (event.target === reportModal) {
      reportModal.style.display = "none";
    }
  });

  // Delete a report
  document.querySelectorAll(".action-btn.delete-report-btn").forEach((button) => {
    button.addEventListener("click", function() {
      const reportId = this.getAttribute("data-id");
      if (confirm("Are you sure you want to delete this report?")) {
        fetch(`/delete-report/${reportId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            document.getElementById(`report-${reportId}`).remove();  // Remove the report row
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("An error occurred while deleting the report.");
        });
      }
    });
  });

  // Function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

});
</script>
{% endblock %}
