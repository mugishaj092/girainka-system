{% extends 'dashboard/layout.html' %}

{% block title %}Source Dashboard{% endblock %}

{% block content %}
<div class="user-container">
  <div class="header">
    <input type="text" placeholder="Search source" class="search-bar">
    <div class="date-range">
      <label for="from">from</label>
      <input type="date" id="from" value="2023-04-04">
      <label for="to">to</label>
      <input type="date" id="to" value="2023-04-04">
    </div>
  </div>
  
  <!-- Table displaying source data -->
  <table>
    <thead>
      <tr>
        <th>Province</th>
        <th>District</th>
        <th>Sector</th>
        <th>Cell</th>
        <th>Village</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for source in page_obj %}
      <tr id="source-{{ source.id }}">
        <td>{{ source.province }}</td>
        <td>{{ source.district }}</td>
        <td>{{ source.sector }}</td>
        <td>{{ source.cell }}</td>
        <td>{{ source.village }}</td>
        <td>{{ source.created_at }}</td>
        <td>
          <button class="action-btn view-source-btn" data-id="{{ source.id }}">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn delete-source-btn" id="delete-source-{{ source.id }}" data-id="{{ source.id }}">
            <i class="fas fa-trash"></i>
          </button>        
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7">No sources found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal for displaying source details -->
<div id="sourceModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Source Details</h2>
    <div id="sourceDetails">
      <!-- Source details will be populated here -->
    </div>
  </div>
</div>

<!-- Pagination controls -->
<div class="pagination-controls">
  <span>Rows Per Page:
    <select id="rowsPerPage" onchange="changeRowsPerPage(this.value)">
        <option value="5" {% if page_obj.paginator.per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if page_obj.paginator.per_page == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if page_obj.paginator.per_page == 15 %}selected{% endif %}>15</option>
        <option value="20" {% if page_obj.paginator.per_page == 20 %}selected{% endif %}>20</option>
    </select>
  </span>
  <span>{{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}</span>
  <span>
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&rows={{ page_obj.paginator.per_page }}" class="pagination-btn">Previous</a>
    {% else %}
    <span class="pagination-btn disabled">Previous</span>
    {% endif %}
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&rows={{ page_obj.paginator.per_page }}" class="pagination-btn">Next</a>
    {% else %}
    <span class="pagination-btn disabled">Next</span>
    {% endif %}
  </span>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sourceModal = document.getElementById("sourceModal");
    const closeModalBtn = document.querySelector(".close-btn");
    const sourceDetailsDiv = document.getElementById("sourceDetails");

    // Open modal to view source details
    document.querySelectorAll(".action-btn.view-source-btn").forEach((button) => {
      button.addEventListener("click", function() {
        const sourceId = this.getAttribute("data-id");
        console.log(sourceId);
        fetch(`/get-source/${sourceId}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const source = data.source;
              // Populating modal with source details
              sourceDetailsDiv.innerHTML = `
                <p><strong>Province:</strong> ${source.province}</p>
                <p><strong>District:</strong> ${source.district}</p>
                <p><strong>Sector:</strong> ${source.sector}</p>
                <p><strong>Cell:</strong> ${source.cell}</p>
                <p><strong>Village:</strong> ${source.village}</p>
                <p><strong>Created At:</strong> ${source.created_at}</p>
              `;
              sourceModal.style.display = "block";  // Show modal
            } else {
              alert("Failed to load source details.");
            }
          })
          .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while loading source data.");
          });
      });
    });

    // Close the modal
    closeModalBtn.addEventListener("click", () => {
      sourceModal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
      if (event.target === sourceModal) {
        sourceModal.style.display = "none";
      }
    });

    // Delete a source
    document.querySelectorAll(".action-btn.delete-source-btn").forEach((button) => {
      button.addEventListener("click", function() {
        const sourceId = this.getAttribute("data-id");
        if (confirm("Are you sure you want to delete this source?")) {
          fetch(`/delete-source/${sourceId}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              document.getElementById(`source-${sourceId}`).remove();  // Remove the source row
            } else {
              alert(data.message);
            }
          })
          .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while deleting the source.");
          });
        }
      });
    });

    // Function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
