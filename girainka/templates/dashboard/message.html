{% extends 'dashboard/layout.html' %}

{% block title %}Message Dashboard{% endblock %}

{% block content %}
<div class="user-container">
  <div class="header">
    <input type="text" placeholder="Search by name or email" class="search-bar">
    <div class="date-range">
      <label for="from">from</label>
      <input type="date" id="from" value="2023-04-04">
      <label for="to">to</label>
      <input type="date" id="to" value="2023-04-04">
    </div>
  </div>
  
  <!-- Table displaying message data -->
  <table>
    <thead>
      <tr>
        <th>Sender Name</th>
        <th>Email</th>
        <th>Message</th>
        <th>Received At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for message in page_obj %}
      <tr id="message-{{ message.id }}">
        <td>{{ message.names }}</td>
        <td>{{ message.email }}</td>
        <td>{{ message.message }}</td>
        <td>{{ message.created_at }}</td>
        <td>
          <button class="action-btn view-message-btn" data-id="{{ message.id }}">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn delete-message-btn" id="delete-message-{{ message.id }}" data-id="{{ message.id }}">
            <i class="fas fa-trash"></i>
          </button>        
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">No messages found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal for displaying message details -->
<div id="messageModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Message Details</h2>
    <div id="messageDetails">
      <!-- Message details will be populated here -->
    </div>
  </div>
</div>

<!-- Pagination controls -->
<div class="pagination-controls">
  <span>Rows Per Page:
    <select id="rowsPerPage" onchange="changeRowsPerPage(this.value)">
        <option value="5" {% if page_obj.paginator.per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if page_obj.paginator.per_page == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if page_obj.paginator.per_page == 15 %}selected{% endif %}>15</option>
        <option value="20" {% if page_obj.paginator.per_page == 20 %}selected{% endif %}>20</option>
    </select>
  </span>
  <span>{{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}</span>
  <span>
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&rows={{ page_obj.paginator.per_page }}" class="pagination-btn">Previous</a>
    {% else %}
    <span class="pagination-btn disabled">Previous</span>
    {% endif %}
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&rows={{ page_obj.paginator.per_page }}" class="pagination-btn">Next</a>
    {% else %}
    <span class="pagination-btn disabled">Next</span>
    {% endif %}
  </span>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const messageModal = document.getElementById("messageModal");
  const closeModalBtn = document.querySelector(".close-btn");
  const messageDetailsDiv = document.getElementById("messageDetails");

  // Open modal to view message details
  document.querySelectorAll(".action-btn.view-message-btn").forEach((button) => {
    button.addEventListener("click", function() {
      const messageId = this.getAttribute("data-id");
      console.log(messageId);
      fetch(`/get-message/${messageId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const message = data.message;
            // Populating modal with message details
            messageDetailsDiv.innerHTML = `
              <p><strong>Sender Name:</strong> ${message.names}</p>
              <p><strong>Email:</strong> ${message.email}</p>
              <p><strong>Message:</strong> ${message.message}</p>
              <p><strong>Received At:</strong> ${message.created_at}</p>
            `;
            messageModal.style.display = "block";  // Show modal
          } else {
            alert("Failed to load message details.");
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("An error occurred while loading message data.");
        });
    });
  });

  // Close the modal
  closeModalBtn.addEventListener("click", () => {
    messageModal.style.display = "none";
  });

  window.addEventListener("click", (event) => {
    if (event.target === messageModal) {
      messageModal.style.display = "none";
    }
  });

  // Delete a message
  document.querySelectorAll(".action-btn.delete-message-btn").forEach((button) => {
    button.addEventListener("click", function() {
      const messageId = this.getAttribute("data-id");
      if (confirm("Are you sure you want to delete this message?")) {
        fetch(`/delete-message/${messageId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            document.getElementById(`message-${messageId}`).remove();  // Remove the message row
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("An error occurred while deleting the message.");
        });
      }
    });
  });

  // Function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
